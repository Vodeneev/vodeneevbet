# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –¥–µ–ø–ª–æ—é

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç, —á—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ –≤—Å–µ–≥–¥–∞ –∑–∞–ø—É—â–µ–Ω–∞ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–µ–ø–ª–æ—è

- **vm-parsers** (158.160.197.172): –ó–∞–ø—É—Å–∫–∞–µ—Ç Parser Service
- **vm-core-services** (158.160.200.253): –ó–∞–ø—É—Å–∫–∞–µ—Ç Calculator Service

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –î–µ–ø–ª–æ–π –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

**Linux/Mac (bash):**
```bash
make deploy-all
# –∏–ª–∏
./scripts/deploy/deploy-all.sh
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è

–°–∫—Ä–∏–ø—Ç—ã `scripts/deploy/deploy-*.sh` –æ–∂–∏–¥–∞—é—Ç, —á—Ç–æ –≤—ã —É–∫–∞–∂–µ—Ç–µ, –æ—Ç–∫—É–¥–∞ —Ç—è–Ω—É—Ç—å –æ–±—Ä–∞–∑—ã:

```bash
export IMAGE_OWNER="vodeneev"   # namespace –≤ GHCR (–æ–±—ã—á–Ω–æ –≤–ª–∞–¥–µ–ª–µ—Ü —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è)
export IMAGE_TAG="main"         # –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ–≥

# –µ—Å–ª–∏ –æ–±—Ä–∞–∑—ã –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ:
export GHCR_TOKEN="..."         # PAT —Å read:packages
export GHCR_USERNAME="vodeneev" # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

# –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–∏–Ω–∫–Ω—É—Ç—å ./keys –Ω–∞ VM (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä–∏–ø—Ç –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –∫–ª—é—á–∏):
export COPY_KEYS=1
```

### –î–µ–ø–ª–æ–π –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

**Parser Service:**
```bash
make deploy-parsers
# –∏–ª–∏
./scripts/deploy/deploy-parsers.sh
```

**Core Services (Calculator):**
```bash
make deploy-core
# –∏–ª–∏
./scripts/deploy/deploy-core-services.sh
```

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è

–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–µ–ø–ª–æ—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç **Docker Compose –Ω–∞ VM** (–±–µ–∑ rsync –∫–æ–¥–∞ –∏ –±–µ–∑ —Å–±–æ—Ä–∫–∏ Go –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ):

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** ‚Äî SSH –¥–æ VM
2. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π** ‚Äî `/opt/vodeneevbet/{parsers,core}`
3. **–ó–∞–≥—Ä—É–∑–∫–∞ `docker-compose.yml`** ‚Äî –∏–∑ `deploy/vm-*/docker-compose.yml`
4. **–°–∏–Ω–∫ `configs/`** ‚Äî –∫–ª–∞–¥—ë—Ç—Å—è —Ä—è–¥–æ–º —Å compose (–∫–ª—é—á–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
5. **Pull & up** ‚Äî `docker compose pull && docker compose up -d`

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
make status
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
# Parser
ssh vm-parsers "sudo docker ps --filter name=vodeneevbet-parser"

# Calculator
ssh vm-core-services "sudo docker ps --filter name=vodeneevbet-calculator"
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
# Parser logs
make logs-parser
# –∏–ª–∏
ssh vm-parsers "sudo docker logs -f vodeneevbet-parser"

# Calculator logs
make logs-calculator
# –∏–ª–∏
ssh vm-core-services "sudo docker logs -f vodeneevbet-calculator"
```

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞/–ó–∞–ø—É—Å–∫

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
make stop-all

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
make start-all
```

## Legacy: systemd –¥–µ–ø–ª–æ–π

–°—Ç–∞—Ä—ã–µ systemd-—Å–∫—Ä–∏–ø—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –≤ `scripts/deploy/legacy/`, –Ω–æ **–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è**:
- `scripts/deploy/legacy/deploy-parsers.systemd.sh`
- `scripts/deploy/legacy/deploy-core-services.systemd.sh`

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ù–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:

1. **Docker**
2. **Docker Compose** (–ø–ª–∞–≥–∏–Ω `docker compose` –∏–ª–∏ `docker-compose`)
3. **SSH –¥–æ—Å—Ç—É–ø** —Å –ø—Ä–∞–≤–∞–º–∏ sudo –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `vodeneevm`

### –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ:

1. **SSH –∫–ª–∏–µ–Ω—Ç** —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º –∫ VM
2. **rsync** (–¥–ª—è —Å–∏–Ω–∫–∞ `configs/`)
3. **Make** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–µ–ø–ª–æ—è —á–µ—Ä–µ–∑ CI/CD

### GitHub Actions

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ GitHub Actions —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω! –§–∞–π–ª `.github/workflows/deploy.yml` —Å–æ–∑–¥–∞–Ω.

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
1. –°–æ–∑–¥–∞–π—Ç–µ SSH –∫–ª—é—á –¥–ª—è –¥–µ–ø–ª–æ—è
2. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –≤ GitHub Secrets –∫–∞–∫ `SSH_PRIVATE_KEY`
3. –î–æ–±–∞–≤—å—Ç–µ –∞–¥—Ä–µ—Å–∞ VM –≤ GitHub Secrets:
   - `VM_PARSERS_HOST` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `158.160.197.172`)
   - `VM_CORE_HOST` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `158.160.200.253`)
4. *(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)* –¥–æ–±–∞–≤—å—Ç–µ `VM_USER`, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ VM –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç `vodeneevm`
5. –ï—Å–ª–∏ –æ–±—Ä–∞–∑—ã –≤ GHCR –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ `GHCR_TOKEN` (PAT —Å `read:packages`) –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ `GHCR_USERNAME`
3. –ü—Ä–∏ –ø—É—à–µ –≤ `main`/`master` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –¥–µ–ø–ª–æ–π

üìñ **–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** [docs/CI_CD_SETUP.md](CI_CD_SETUP.md)

### GitLab CI

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ GitLab CI —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω! –§–∞–π–ª `.gitlab-ci.yml` —Å–æ–∑–¥–∞–Ω.

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
1. –°–æ–∑–¥–∞–π—Ç–µ SSH –∫–ª—é—á –¥–ª—è –¥–µ–ø–ª–æ—è
2. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –≤ GitLab CI/CD Variables –∫–∞–∫ `SSH_PRIVATE_KEY`
3. –ü—Ä–∏ –ø—É—à–µ –≤ `main`/`master` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –¥–µ–ø–ª–æ–π

üìñ **–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** [docs/CI_CD_SETUP.md](CI_CD_SETUP.md)

### Git Hook –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è

–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–º–∏—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ:

–°–æ–∑–¥–∞–π—Ç–µ `.git/hooks/post-commit`:

```bash
#!/bin/bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞
./scripts/deploy/deploy-all.sh
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "Cannot connect to VM"

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: `ssh vm-parsers`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SSH config –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞ 22: `Test-NetConnection -ComputerName 158.160.197.172 -Port 22`

### –ü—Ä–æ–±–ª–µ–º–∞: "Permission denied"

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `vodeneevm` –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ sudo
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: `ssh vm-parsers "ls -la /opt/vodeneevbet"`

### –ü—Ä–æ–±–ª–µ–º–∞: "go: command not found"

**–†–µ—à–µ–Ω–∏–µ:**
–î–ª—è compose-–¥–µ–ø–ª–æ—è Go –Ω–∞ VM –Ω–µ –Ω—É–∂–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞ VM —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã Docker –∏ Docker Compose.

### –ü—Ä–æ–±–ª–µ–º–∞: –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `ssh vm-parsers "sudo docker logs --tail=200 vodeneevbet-parser"`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: `ssh vm-parsers "cat /opt/vodeneevbet/parsers/configs/local.yaml"`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: `ssh vm-parsers "ls -la /opt/vodeneevbet/parsers"`

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ VM

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ VM –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

```
/opt/vodeneevbet/
‚îú‚îÄ‚îÄ parsers/
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îú‚îÄ‚îÄ .env
‚îÇ   ‚îú‚îÄ‚îÄ configs/
‚îÇ   ‚îî‚îÄ‚îÄ keys/   # –æ–±—ã—á–Ω–æ –≤—Ä—É—á–Ω—É—é (—Å–µ–∫—Ä–µ—Ç—ã)
‚îî‚îÄ‚îÄ core/
    ‚îú‚îÄ‚îÄ docker-compose.yml
    ‚îú‚îÄ‚îÄ .env
    ‚îú‚îÄ‚îÄ configs/
    ‚îî‚îÄ‚îÄ keys/   # –æ–±—ã—á–Ω–æ –≤—Ä—É—á–Ω—É—é (—Å–µ–∫—Ä–µ—Ç—ã)
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- SSH –∫–ª—é—á–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞—â–∏—â–µ–Ω—ã
- Service account –∫–ª—é—á–∏ –¥–ª—è YDB –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ–ø–∞–¥–∞—Ç—å –≤ git
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.gitignore` –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `go mod tidy`
