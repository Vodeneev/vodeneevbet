# Варианты архитектуры расчета диффов для множества контор

## Текущая проблема

Сейчас `computeTopDiffs` просто находит min и max среди всех контор. При большом количестве контор это приводит к:
- Много шума (небольшие различия между конторами)
- Нет приоритизации надежных контор
- O(n²) сравнений при росте количества контор
- Не учитывается поле `ReferenceBookmakers` из конфига

## Варианты решения

### Вариант 1: Reference-Based (Рекомендуемый) ⭐

**Идея:** Сравнивать каждую контору с референсными конторами (надежными).

**Логика:**
- Для каждой ставки находим лучший коэффициент среди референсных контор
- Сравниваем все остальные конторы с этим референсным значением
- Находим максимальный дифф: `(odd / reference_odd - 1) * 100`

**Преимущества:**
- ✅ Простая и понятная логика
- ✅ Фокус на надежных конторах
- ✅ Легко масштабируется (O(n * m), где n - все конторы, m - референсные)
- ✅ Уже есть поле `ReferenceBookmakers` в конфиге

**Недостатки:**
- Может пропустить хорошие диффы между двумя не-референсными конторами

**Пример:**
```go
// Для каждой ставки:
referenceOdd := findBestOdd(referenceBookmakers) // e.g., 2.0 от Pinnacle
for each bookmaker:
    if bookmaker not in referenceBookmakers:
        diff = (bookmakerOdd / referenceOdd - 1) * 100
        if diff > threshold:
            add to results
```

---

### Вариант 2: Best vs Reference

**Идея:** Найти лучший коэффициент среди всех контор, сравнить с референсными.

**Логика:**
- Находим лучший (максимальный) коэффициент среди всех контор
- Находим лучший коэффициент среди референсных контор
- Считаем дифф: `(best_odd / reference_best_odd - 1) * 100`

**Преимущества:**
- ✅ Показывает реальную выгоду (лучший коэффициент vs референсный)
- ✅ Простая логика
- ✅ Фокус на value bets

**Недостатки:**
- Может пропустить случаи, когда лучший коэффициент от референсной конторы

**Пример:**
```go
bestOdd := findMaxOdd(allBookmakers) // e.g., 2.5 от новой конторы
referenceBestOdd := findMaxOdd(referenceBookmakers) // e.g., 2.0 от Pinnacle
diff = (bestOdd / referenceBestOdd - 1) * 100 // 25%
```

---

### Вариант 3: Tier-Based Comparison

**Идея:** Разделить конторы на тиры (надежные, средние, новые) и сравнивать между тирами.

**Логика:**
- Tier 1: Reference bookmakers (Pinnacle, Betfair, etc.)
- Tier 2: Established bookmakers (Bet365, William Hill, etc.)
- Tier 3: New/unknown bookmakers
- Сравниваем: Tier 2 vs Tier 1, Tier 3 vs Tier 1, Tier 3 vs Tier 2

**Преимущества:**
- ✅ Гибкая система приоритетов
- ✅ Можно настраивать пороги для разных тиров
- ✅ Хорошо масштабируется

**Недостатки:**
- Более сложная логика
- Нужна конфигурация тиров

**Пример конфига:**
```yaml
bookmaker_tiers:
  tier1: ["pinnacle", "betfair"]  # Reference
  tier2: ["bet365", "williamhill"] # Established
  tier3: ["pinnacle888", "new_bk"] # New/unknown
```

---

### Вариант 4: Pairwise with Filtering

**Идея:** Сравнивать все пары контор, но с фильтрацией и приоритизацией.

**Логика:**
- Сравниваем все пары контор
- Приоритет парам, где одна из контор - референсная
- Фильтруем по минимальному порогу диффа
- Ограничиваем количество результатов

**Преимущества:**
- ✅ Не пропускает хорошие диффы
- ✅ Полный охват

**Недостатки:**
- O(n²) сложность
- Много шума при большом количестве контор
- Нужна агрессивная фильтрация

---

### Вариант 5: Weighted Comparison

**Идея:** Учитывать "вес" конторы при расчете диффа.

**Логика:**
- Каждой конторе присваивается вес (reliability score)
- При расчете диффа учитывается вес: `diff_weighted = diff * (1 - reference_weight) * bookmaker_weight`
- Референсные конторы имеют вес 1.0, новые - 0.5-0.7

**Преимущества:**
- ✅ Гибкая система приоритетов
- ✅ Можно учитывать историю надежности

**Недостатки:**
- Сложная логика
- Нужна система расчета весов

---

## Рекомендация: Вариант 1 (Reference-Based) + Вариант 2 (Best vs Reference)

**Гибридный подход:**

1. **Основной расчет (Reference-Based):**
   - Для каждой ставки находим лучший коэффициент среди референсных контор
   - Сравниваем все остальные конторы с этим значением
   - Это показывает, насколько другие конторы лучше/хуже референсных

2. **Дополнительный расчет (Best vs Reference):**
   - Находим абсолютно лучший коэффициент среди всех контор
   - Если он не от референсной конторы, показываем как отдельный результат
   - Это показывает максимальную выгоду

**Результат:**
- Показываем диффы всех контор относительно референсных (основной список)
- Показываем лучшие коэффициенты, если они не от референсных (дополнительно)

**Пример структуры результата:**
```go
type DiffBet struct {
    // ... existing fields ...
    
    // Reference-based diff
    ReferenceBookmaker string  `json:"reference_bookmaker"` // e.g., "Pinnacle"
    ReferenceOdd       float64 `json:"reference_odd"`       // e.g., 2.0
    DiffVsReference    float64 `json:"diff_vs_reference"`  // e.g., 25%
    
    // Best odd info
    IsBestOdd          bool    `json:"is_best_odd"`        // true if this is the best odd
    BestOddSource      string  `json:"best_odd_source"`    // which bookmaker has best odd
}
```

---

## План миграции

1. **Этап 1:** Реализовать Reference-Based расчет
   - Использовать `ReferenceBookmakers` из конфига
   - Для каждой ставки найти лучший коэффициент среди референсных
   - Сравнить все конторы с референсным значением

2. **Этап 2:** Добавить Best vs Reference
   - Найти абсолютно лучший коэффициент
   - Если он не от референсной конторы, добавить отдельную запись

3. **Этап 3:** Оптимизация и фильтрация
   - Добавить минимальный порог диффа (например, 5%)
   - Кэширование референсных коэффициентов
   - Параллельная обработка

---

## Конфигурация

```yaml
value_calculator:
  reference_method: "reference_based"  # или "best_vs_reference", "hybrid"
  reference_bookmakers: ["pinnacle", "betfair", "sbobet"]
  min_diff_percent: 5.0  # Минимальный дифф для показа (новое поле)
  diff_calculation_mode: "hybrid"  # "reference_based", "best_vs_reference", "hybrid"
```

---

## Вопросы для обсуждения

1. Нужно ли показывать диффы между двумя не-референсными конторами?
2. Какой минимальный порог диффа считать значимым? (5%, 10%?)
3. Нужна ли поддержка нескольких методов расчета одновременно?
4. Как обрабатывать случаи, когда референсная контора не имеет коэффициента для ставки?
