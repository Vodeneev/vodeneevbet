# Инструкция по проверке маппинга событий

## Что проверяется

1. Количество матчей по каждому букмекеру
2. Типы событий (event_type) по каждому букмекеру  
3. Потенциальные проблемы маппинга (нестандартные типы событий, разные типы у одного матча)
4. Статистика по типам исходов (outcome_type)
5. Количество связок в таблице diff_bets
6. **Матчи-одиночки** - матчи, которые есть только у одного букмекера (потенциальная проблема сопоставления)
7. **Нормализация букмекеров** - проверка, что все записи используют единообразные названия (например, `fonbet`, а не `Fonbet`)
8. **Проверка Olimp** - специальная проверка для матчей Olimp (транслитерация названий команд)

## Способ 1: Прямое подключение к БД (рекомендуется)

### На сервере calculator (158.160.222.217):

```bash
# 1. Установить сертификат (уже установлен)
# mkdir -p ~/.postgresql && \
# wget "https://storage.yandexcloud.net/cloud-certs/CA.pem" \
#      --output-document ~/.postgresql/root.crt && \
# chmod 0655 ~/.postgresql/root.crt

# 2. Запустить проверку с паролем
/tmp/run-check-mapping.sh <ваш_пароль>

# Или напрямую:
/tmp/check-mapping \
    -host "rc1a-fec715cq0rept3kd.mdb.yandexcloud.net,rc1a-h8tc88gfbg9v7anh.mdb.yandexcloud.net" \
    -port 6432 \
    -user "vodeneevm" \
    -password "<ваш_пароль>" \
    -dbname "db" \
    -sslmode "verify-full" \
    -sslrootcert "$HOME/.postgresql/root.crt"
```

### Параметры подключения:

- **Host**: `rc1a-fec715cq0rept3kd.mdb.yandexcloud.net,rc1a-h8tc88gfbg9v7anh.mdb.yandexcloud.net`
- **Port**: `6432`
- **User**: `vodeneevm`
- **Database**: `db`
- **SSL Mode**: `verify-full`
- **SSL Root Cert**: `~/.postgresql/root.crt`

## Способ 2: Через API (если доступен)

### Если API калькулятора доступен:

```bash
# На сервере calculator:
/tmp/check-mapping-api -url http://localhost:8080/matches

# Или через внешний IP:
/tmp/check-mapping-api -url http://158.160.222.217:8080/matches
```

### Если API парсера доступен:

```bash
# На сервере parser:
/tmp/check-mapping-api -url http://localhost:8080/matches
```

## Способ 3: SQL скрипт (если есть psql)

```bash
# Если установлен psql и есть доступ к БД:
psql "postgres://vodeneevm:<пароль>@rc1a-fec715cq0rept3kd.mdb.yandexcloud.net:6432/db?sslmode=verify-full&sslrootcert=$HOME/.postgresql/root.crt" \
    -f /tmp/check-mapping.sql
```

## Что искать в результатах

### ✅ Хорошие признаки:

1. **Стандартные типы событий** - все события используют стандартные типы:
   - `main_match`
   - `corners`
   - `yellow_cards`
   - `fouls`
   - `shots_on_target`
   - `offsides`
   - `throw_ins`

2. **Единообразие** - один и тот же матч у разных букмекеров имеет одинаковые типы событий

3. **Низкий процент одиночек** - большинство матчей присутствуют у нескольких букмекеров (хороший признак сопоставления)

4. **Нормализованные названия букмекеров** - все записи используют единообразные названия (например, `fonbet`, `olimp` в нижнем регистре)

### ⚠️ Проблемы маппинга:

1. **Нестандартные типы событий** - события, которые не входят в стандартный список могут указывать на проблему маппинга

2. **Разные типы событий для одного матча** - если один и тот же матч у разных букмекеров имеет разные типы событий, это может указывать на проблему маппинга

3. **Отсутствие событий** - если у букмекера нет определенных типов событий, которые есть у других

4. **Высокий процент одиночек** - если у букмекера 100% матчей-одиночек (например, Olimp), это указывает на проблему сопоставления:
   - Возможные причины: кириллические названия команд, разные форматы времени, разные нормализации названий команд

5. **Дублирование букмекеров** - если `Fonbet` и `fonbet` считаются разными букмекерами, это проблема нормализации

## Примеры проблем

### Проблема 1: Все события маппятся как `main_match`
Если для киберспорта все события (тоталы, форы) маппятся как `main_match`, это проблема - они должны быть `total_maps`, `handicap_maps` и т.д.

### Проблема 2: Разные названия для одного типа события
Если один букмекер использует `corners`, а другой `corner_kicks`, это проблема маппинга.

### Проблема 3: Дублирование букмекеров (Fonbet vs fonbet)
**Симптомы:**
- В статистике видно `Fonbet: X матчей` и `fonbet: Y матчей` как отдельные букмекеры
- Связки между `Fonbet` и другими букмекерами, но нет связок с `fonbet`

**Решение:**
- Использовать скрипт `migrate-bookmaker-names` для нормализации старых записей
- Убедиться, что парсеры используют нормализованные названия (lowercase)

### Проблема 4: Olimp - 100% одиночек
**Симптомы:**
- Olimp имеет 100% матчей-одиночек (нет связок с другими букмекерами)
- В базе видны кириллические названия команд для Olimp

**Причины:**
- Olimp API возвращает кириллические названия команд
- Другие букмекеры используют латинские названия
- Из-за этого `match_group_key` не совпадает

**Решение:**
- Парсер Olimp теперь использует транслитерацию (как Marathonbet)
- Проверить новые записи после деплоя: `/tmp/check-olimp-team-names`

## Дополнительные скрипты для диагностики

### Проверка матчей-одиночек

```bash
# На сервере calculator:
/tmp/check-mapping -dsn "host=... port=6432 user=vodeneevm password=... dbname=db sslmode=verify-full sslrootcert=$HOME/.postgresql/root.crt" | grep -A 20 "Матчи-одиночки"
```

### Проверка нормализации букмекеров

```bash
# Проверка fonbet/Fonbet:
/tmp/check-mapping -dsn "..." | grep -A 10 "Проверка нормализации"
```

### Проверка Olimp матчей

```bash
# Проверка примеров матчей Olimp и их сопоставления:
/tmp/check-olimp-matches -dsn "..."

# Проверка названий команд Olimp (новые vs старые записи):
/tmp/check-olimp-team-names -dsn "..."
```

### Миграция названий букмекеров

```bash
# Сухой прогон (проверка без изменений):
/tmp/migrate-bookmaker-names -dsn "..." --dry-run

# Реальная миграция:
/tmp/migrate-bookmaker-names -dsn "..."
```

**Важно:** Перед миграцией обязательно сделать бэкап базы данных!

## Файлы на серверах

### На сервере calculator (158.160.222.217):
- `/tmp/check-mapping` - Go бинарник для проверки через БД
- `/tmp/check-mapping-api` - Go бинарник для проверки через API
- `/tmp/check-olimp-matches` - Проверка матчей Olimp
- `/tmp/check-olimp-team-names` - Проверка названий команд Olimp
- `/tmp/migrate-bookmaker-names` - Миграция названий букмекеров
- `/tmp/run-check-mapping.sh` - Скрипт для запуска с параметрами
- `~/.postgresql/root.crt` - SSL сертификат

### На сервере parser (158.160.168.187):
- `/tmp/check-mapping` - Go бинарник для проверки через БД
- `/tmp/check-mapping.sql` - SQL скрипт для проверки
- `/tmp/check-mapping-api` - Go бинарник для проверки через API

## Исходный код

- `cmd/check-mapping/main.go` - скрипт для проверки через БД (включает проверку одиночек и нормализации)
- `cmd/check-mapping-api/main.go` - скрипт для проверки через API
- `cmd/check-olimp-matches/main.go` - проверка матчей Olimp и их сопоставления
- `cmd/check-olimp-team-names/main.go` - проверка названий команд Olimp (кириллица vs латиница)
- `cmd/migrate-bookmaker-names/main.go` - миграция названий букмекеров в БД
- `scripts/check-mapping.sql` - SQL скрипт
- `scripts/check-single-bookmaker-matches.sql` - SQL скрипт для проверки одиночек
- `scripts/run-check-mapping.sh` - bash скрипт для запуска

## Известные исправления

### Исправление нормализации Fonbet
- **Проблема:** `Fonbet` и `fonbet` считались разными букмекерами
- **Решение:** Все парсеры теперь используют lowercase названия (`fonbet`)
- **Миграция:** Использовать `migrate-bookmaker-names` для обновления старых записей

### Исправление транслитерации Olimp
- **Проблема:** Olimp возвращал кириллические названия команд, что приводило к 100% одиночек
- **Решение:** Добавлена транслитерация (как в Marathonbet) в `internal/parser/parsers/olimp/transliterate.go`
- **Проверка:** После деплоя использовать `check-olimp-team-names` для проверки новых записей
