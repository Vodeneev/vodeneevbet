# Сравнение подходов для расчета валуя

## Вариант 1: Только референсные конторы (текущий)

**Логика:**
- Берем коэффициенты только от референсных контор
- Считаем средневзвешенную вероятность
- Сравниваем остальные конторы с этим значением

**Плюсы:**
- ✅ Используем только надежные источники
- ✅ Не "размывается" новыми/ненадежными конторами
- ✅ Более стабильная оценка

**Минусы:**
- ❌ Нужно настраивать список референсных контор
- ❌ Если референсная контора дает плохой коэффициент, он все равно влияет
- ❌ Игнорируем информацию от других контор

**Пример проблемы:**
```
Референсные: Pinnacle 2.0, Betfair 2.1 → среднее 2.05
Контора X: 2.5 → валуй 22%
Но если Betfair дал плохой коэффициент 1.8, среднее будет 1.9, и X будет выглядеть как 32% валуй (ложный сигнал)
```

---

## Вариант 2: Среднее от всех контор

**Логика:**
- Берем коэффициенты от всех контор
- Считаем среднее (простое или взвешенное)
- Сравниваем каждую контору (включая те, что участвовали в расчете) с этим средним

**Плюсы:**
- ✅ Проще - не нужно настраивать референсные конторы
- ✅ Используем всю доступную информацию
- ✅ "Рыночная" оценка - среднее от всех участников рынка
- ✅ Автоматически адаптируется к новым конторам

**Минусы:**
- ❌ Новые/ненадежные конторы могут "размыть" среднее
- ❌ Если одна контора дает очень плохой коэффициент, она может "потянуть" среднее

**Пример:**
```
Все конторы: Pinnacle 2.0, Betfair 2.1, Bet365 1.9, NewBK 1.5 → среднее 1.875
Pinnacle 2.0 vs среднее 1.875 → валуй 6.7%
NewBK 1.5 vs среднее 1.875 → не валуй (ниже среднего)
```

---

## Вариант 3: Взвешенное среднее от всех контор (РЕКОМЕНДУЕМЫЙ) ⭐

**Логика:**
- Берем коэффициенты от всех контор
- Считаем взвешенное среднее (надежные конторы имеют больший вес)
- Сравниваем каждую контору с этим средним

**Плюсы:**
- ✅ Используем всю информацию
- ✅ Надежные конторы имеют больше влияния
- ✅ Новые конторы учитываются, но с меньшим весом
- ✅ Не нужно жестко разделять на референсные/не-референсные
- ✅ Более гибкий подход

**Минусы:**
- ❌ Нужна конфигурация весов (но это опционально - по умолчанию все равны)

**Пример:**
```
Конторы с весами:
- Pinnacle: 2.0 (вес 1.0)
- Betfair: 2.1 (вес 0.95)
- Bet365: 1.9 (вес 0.85)
- NewBK: 1.5 (вес 0.3) ← новая контора, маленький вес

Взвешенное среднее: ~1.95 (ближе к надежным конторам)
Pinnacle 2.0 vs 1.95 → валуй 2.6%
NewBK 1.5 vs 1.95 → не валуй (ниже среднего)
```

---

## Рекомендация: Вариант 3 (Взвешенное среднее от всех)

**Почему:**
1. **Используем всю информацию** - не игнорируем данные от новых контор
2. **Гибкость** - можно настроить веса, но по умолчанию все равны
3. **Автоматическая адаптация** - новые конторы автоматически учитываются
4. **Меньше конфигурации** - не нужно жестко делить на референсные/не-референсные

**Логика:**
```go
// Для каждой ставки:
// 1. Собираем все коэффициенты от всех контор
// 2. Считаем взвешенное среднее (с весами из конфига или все равны 1.0)
// 3. Для каждой конторы считаем валуй: (odd / avg_odd - 1) * 100
// 4. Если валуй > threshold, показываем
```

**Конфигурация:**
```yaml
value_calculator:
  # Опционально: веса контор (по умолчанию все равны 1.0)
  bookmaker_weights:
    pinnacle: 1.0      # эталон
    betfair: 0.95
    bet365: 0.85
    pinnacle888: 0.7  # новая контора, меньше вес
  
  min_value_percent: 5.0
```

**Преимущества перед текущим подходом:**
- Не нужно настраивать `reference_bookmakers` - все конторы учитываются автоматически
- Новые конторы сразу начинают работать
- Более "рыночная" оценка - среднее от всех участников
- Гибкость через веса - можно усилить влияние надежных контор

---

## Альтернатива: Гибридный подход

Можно сделать оба варианта доступными через конфиг:

```yaml
value_calculator:
  calculation_mode: "weighted_all"  # "reference_only" или "weighted_all"
  
  # Если reference_only:
  reference_bookmakers: ["pinnacle", "betfair"]
  
  # Если weighted_all (или всегда):
  bookmaker_weights:
    pinnacle: 1.0
    betfair: 0.95
    # ...
```

Но для простоты лучше выбрать один подход - **взвешенное среднее от всех**.
