# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –¥–µ–ø–ª–æ—é

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç, —á—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ –≤—Å–µ–≥–¥–∞ –∑–∞–ø—É—â–µ–Ω–∞ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–µ–ø–ª–æ—è

- **vm-parsers** (158.160.197.172): –ó–∞–ø—É—Å–∫–∞–µ—Ç Parser Service
- **vm-core-services** (158.160.200.253): –ó–∞–ø—É—Å–∫–∞–µ—Ç Calculator –∏ API Services

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –î–µ–ø–ª–æ–π –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

**Linux/Mac (bash):**
```bash
make deploy-all
# –∏–ª–∏
./scripts/deploy/deploy-all.sh
```

**Windows (PowerShell):**
```powershell
.\scripts\deploy\deploy-all.ps1
```

### –î–µ–ø–ª–æ–π –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

**Parser Service:**
```bash
make deploy-parsers
# –∏–ª–∏
./scripts/deploy/deploy-parsers.sh
```

**Core Services (Calculator + API):**
```bash
make deploy-core
# –∏–ª–∏
./scripts/deploy/deploy-core-services.sh
```

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å VM —á–µ—Ä–µ–∑ SSH
2. **–°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π** - –°–æ–∑–¥–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤** - –ö–æ–ø–∏—Ä—É–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–¥ –Ω–∞ VM
4. **–°–±–æ—Ä–∫–∞** - –ö–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç Go —Å–µ—Ä–≤–∏—Å—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ
5. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ systemd** - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ systemd
6. **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫** - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–∏—Å—ã —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
make status
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
# Parser
ssh vm-parsers "sudo systemctl status vodeneevbet-parser"

# Calculator
ssh vm-core-services "sudo systemctl status vodeneevbet-calculator"

# API
ssh vm-core-services "sudo systemctl status vodeneevbet-api"
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
# Parser logs
make logs-parser
# –∏–ª–∏
ssh vm-parsers "sudo journalctl -u vodeneevbet-parser -f"

# Calculator logs
make logs-calculator
# –∏–ª–∏
ssh vm-core-services "sudo journalctl -u vodeneevbet-calculator -f"

# API logs
make logs-api
# –∏–ª–∏
ssh vm-core-services "sudo journalctl -u vodeneevbet-api -f"
```

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞/–ó–∞–ø—É—Å–∫

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
make stop-all

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
make start-all
```

## Systemd —Å–µ—Ä–≤–∏—Å—ã

–°–µ—Ä–≤–∏—Å—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ —Å–±–æ—è—Ö.

**–§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
- `scripts/deploy/systemd/vodeneevbet-parser.service`
- `scripts/deploy/systemd/vodeneevbet-calculator.service`
- `scripts/deploy/systemd/vodeneevbet-api.service`

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ù–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:

1. **Go** (–≤–µ—Ä—Å–∏—è 1.22+)
   ```bash
   # –ü—Ä–æ–≤–µ—Ä–∫–∞
   ssh vm-parsers "go version"
   ```

2. **Systemd** (–æ–±—ã—á–Ω–æ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ Linux —Å–∏—Å—Ç–µ–º–∞—Ö)

3. **SSH –¥–æ—Å—Ç—É–ø** —Å –ø—Ä–∞–≤–∞–º–∏ sudo –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `vodeneevm`

### –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ:

1. **SSH –∫–ª–∏–µ–Ω—Ç** —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º –∫ VM
2. **rsync** (–¥–ª—è Linux/Mac) –∏–ª–∏ **scp** (–¥–ª—è Windows)
3. **Make** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Makefile)

## –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–µ–ø–ª–æ—è —á–µ—Ä–µ–∑ CI/CD

### GitHub Actions

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ GitHub Actions —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω! –§–∞–π–ª `.github/workflows/deploy.yml` —Å–æ–∑–¥–∞–Ω.

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
1. –°–æ–∑–¥–∞–π—Ç–µ SSH –∫–ª—é—á –¥–ª—è –¥–µ–ø–ª–æ—è
2. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –≤ GitHub Secrets –∫–∞–∫ `SSH_PRIVATE_KEY`
3. –î–æ–±–∞–≤—å—Ç–µ –∞–¥—Ä–µ—Å–∞ VM –≤ GitHub Secrets:
   - `VM_PARSERS_HOST` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `158.160.197.172`)
   - `VM_CORE_HOST` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `158.160.200.253`)
4. *(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)* –¥–æ–±–∞–≤—å—Ç–µ `VM_USER`, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ VM –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç `vodeneevm`
5. –ï—Å–ª–∏ –æ–±—Ä–∞–∑—ã –≤ GHCR –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ `GHCR_TOKEN` (PAT —Å `read:packages`) –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ `GHCR_USERNAME`
3. –ü—Ä–∏ –ø—É—à–µ –≤ `main`/`master` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –¥–µ–ø–ª–æ–π

üìñ **–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** [docs/CI_CD_SETUP.md](CI_CD_SETUP.md)

### GitLab CI

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ GitLab CI —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω! –§–∞–π–ª `.gitlab-ci.yml` —Å–æ–∑–¥–∞–Ω.

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
1. –°–æ–∑–¥–∞–π—Ç–µ SSH –∫–ª—é—á –¥–ª—è –¥–µ–ø–ª–æ—è
2. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –≤ GitLab CI/CD Variables –∫–∞–∫ `SSH_PRIVATE_KEY`
3. –ü—Ä–∏ –ø—É—à–µ –≤ `main`/`master` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –¥–µ–ø–ª–æ–π

üìñ **–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** [docs/CI_CD_SETUP.md](CI_CD_SETUP.md)

### Git Hook –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è

–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–º–∏—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ:

–°–æ–∑–¥–∞–π—Ç–µ `.git/hooks/post-commit`:

```bash
#!/bin/bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞
./scripts/deploy/deploy-all.sh
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "Cannot connect to VM"

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: `ssh vm-parsers`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SSH config –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞ 22: `Test-NetConnection -ComputerName 158.160.197.172 -Port 22`

### –ü—Ä–æ–±–ª–µ–º–∞: "Permission denied"

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `vodeneevm` –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ sudo
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: `ssh vm-parsers "ls -la /home/vodeneevm"`

### –ü—Ä–æ–±–ª–µ–º–∞: "go: command not found"

**–†–µ—à–µ–Ω–∏–µ:**
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Go –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Go –¥–æ–±–∞–≤–ª–µ–Ω –≤ PATH

### –ü—Ä–æ–±–ª–µ–º–∞: –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `sudo journalctl -u vodeneevbet-parser -n 50`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: `cat configs/local.yaml`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã: `ls -la /home/vodeneevm/vodeneevbet/internal/parser/parser`

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ VM

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ VM –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

```
/home/vodeneevm/vodeneevbet/
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ parser/          # –ù–∞ vm-parsers
‚îÇ   ‚îú‚îÄ‚îÄ calculator/      # –ù–∞ vm-core-services
‚îÇ   ‚îú‚îÄ‚îÄ api/             # –ù–∞ vm-core-services
‚îÇ   ‚îî‚îÄ‚îÄ pkg/             # –û–±—â–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
‚îú‚îÄ‚îÄ configs/
‚îÇ   ‚îî‚îÄ‚îÄ local.yaml
‚îú‚îÄ‚îÄ keys/
‚îÇ   ‚îî‚îÄ‚îÄ service-account-key.json
‚îú‚îÄ‚îÄ logs/
‚îú‚îÄ‚îÄ go.mod
‚îî‚îÄ‚îÄ go.sum
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- SSH –∫–ª—é—á–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞—â–∏—â–µ–Ω—ã
- Service account –∫–ª—é—á–∏ –¥–ª—è YDB –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ–ø–∞–¥–∞—Ç—å –≤ git
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.gitignore` –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `go mod tidy`
